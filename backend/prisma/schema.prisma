generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ─── Enums — SCREAMING_SNAKE_CASE (matches PostgreSQL CREATE TYPE values) ─────

enum Role {
  USER
  ADMIN
}

// READ   → view bookings, vehicles, users
// CREATE → add vehicles, create bookings on behalf of users
// DELETE → remove vehicles, bookings, or user accounts
// Empty permissions array = super-admin (full access)
enum AdminPermission {
  READ
  CREATE
  DELETE
}

enum VehicleCategory {
  ECONOMY
  COMFORT
  LUXURY
  SUV
  VAN
}

enum Transmission {
  MANUAL
  AUTOMATIC
}

enum FuelType {
  PETROL
  DIESEL
  ELECTRIC
  HYBRID
}

// PENDING   → awaiting admin confirmation
// CONFIRMED → approved
// CANCELLED → cancelled by user or admin
// COMPLETED → rental finished
enum BookingStatus {
  PENDING
  CONFIRMED
  CANCELLED
  COMPLETED
}

// ACTIVE  → default; can authenticate and book
// BLOCKED → suspended by admin; login returns HTTP 403
enum UserStatus {
  ACTIVE
  BLOCKED
}

// AVAILABLE   → ready for booking
// UNAVAILABLE → temporarily out of service
// MAINTENANCE → under repair
// RENTED      → currently on an active booking
enum VehicleStatus {
  AVAILABLE
  UNAVAILABLE
  MAINTENANCE
  RENTED
}

// PENDING   → payment initiated, not settled
// COMPLETED → successfully processed
// FAILED    → transaction declined or errored
// REFUNDED  → amount returned to customer
enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}

// ─── Models ───────────────────────────────────────────────────────────────────

model User {
  id                    String            @id @default(uuid())
  email                 String            @unique
  // Stores bcrypt hash only — NEVER plaintext
  password              String            
  first_name            String
  last_name             String
  phone                 String?
  role                  Role              @default(USER)
  status                UserStatus        @default(ACTIVE)
  // Empty array = super-admin (all operations allowed)
  permissions           AdminPermission[]
  email_verified        Boolean           @default(false)
  is_active             Boolean           @default(true)
  // Password recovery — 1-hour TTL token
  reset_password_token  String?
  reset_password_expiry DateTime?
  created_at            DateTime          @default(now())
  updated_at            DateTime          @updatedAt

  bookings      Booking[]
  reviews       Review[]
  notifications Notification[]

  @@map("users")
}

model Vehicle {
  id               String          @id @default(uuid())
  brand            String
  model            String
  year             Int
  license_plate    String?         @unique
  category         VehicleCategory
  price_per_day    Decimal         @db.Decimal(10, 2)
  seats            Int
  transmission     Transmission
  fuel_type        FuelType
  image_url        String?
  features         Json?
  description      String?         @db.Text
  // is_available kept for legacy compatibility
  is_available     Boolean         @default(true)
  // status is the authoritative availability flag
  status           VehicleStatus   @default(AVAILABLE)
  mileage          Int?            @default(0)
  location         String?
  location_address String?
  location_lat     Decimal?        @db.Decimal(10, 8)
  location_lng     Decimal?        @db.Decimal(11, 8)
  is_active        Boolean         @default(true)
  created_at       DateTime        @default(now())
  updated_at       DateTime        @updatedAt

  bookings Booking[]
  reviews  Review[]

  @@map("vehicles")
}

model Booking {
  id               String        @id @default(uuid())
  user_id          String
  vehicle_id       String
  start_date       DateTime
  end_date         DateTime
  pickup_location  String?
  dropoff_location String?
  // Denormalized for fast reporting
  total_days       Int
  // Locked at creation — immune to retroactive rate changes
  total_price      Decimal       @db.Decimal(10, 2)
  status           BookingStatus @default(PENDING)
  payment_status   PaymentStatus @default(PENDING)
  notes            String?       @db.Text
  is_active        Boolean       @default(true)
  created_at       DateTime      @default(now())
  updated_at       DateTime      @updatedAt

  user    User    @relation(fields: [user_id],    references: [id], onDelete: Cascade)
  vehicle Vehicle @relation(fields: [vehicle_id], references: [id], onDelete: Cascade)
  payment Payment?
  review  Review?

  @@index([user_id])
  @@index([vehicle_id])
  @@index([start_date, end_date])
  @@map("bookings")
}

model Payment {
  id               String        @id @default(uuid())
  booking_id       String        @unique
  amount           Decimal       @db.Decimal(10, 2)
  payment_method   String
  payment_provider String?
  // External provider reference (e.g. MTN MoMo, Orange Money)
  transaction_id   String?       @unique
  status           PaymentStatus @default(PENDING)
  metadata         Json?         @default("{}")
  is_active        Boolean       @default(true)
  created_at       DateTime      @default(now())
  updated_at       DateTime      @updatedAt

  booking Booking @relation(fields: [booking_id], references: [id], onDelete: Cascade)

  @@map("payments")
}

model Review {
  id         String   @id @default(uuid())
  booking_id String   @unique
  user_id    String
  vehicle_id String
  // Constrained to 1-5 at application layer
  rating     Int
  comment    String?  @db.Text
  is_active  Boolean  @default(true)
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  booking Booking @relation(fields: [booking_id], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [user_id],    references: [id], onDelete: Cascade)
  vehicle Vehicle @relation(fields: [vehicle_id], references: [id], onDelete: Cascade)

  @@map("reviews")
}

model Notification {
  id         String   @id @default(uuid())
  user_id    String
  type       String
  title      String
  message    String   @db.Text
  is_read    Boolean  @default(false)
  // Arbitrary context for deep-linking e.g. { bookingId: "..." }
  metadata   Json?    @default("{}")
  is_active  Boolean  @default(true)
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  user User @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([user_id])
  @@map("notifications")
}
